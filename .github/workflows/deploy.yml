# =============================================================================
# SALES PORTAL - Deploy Infrastructure and Application
# =============================================================================
# Deploys Azure infrastructure using Bicep and updates the Web App with the
# latest container image.
#
# Triggers:
# - Manual workflow dispatch → Dev environment only (during development phase)
#
# NOTE: Staging and production deployments are SUSPENDED during development.
# To re-enable, uncomment the push triggers below and add staging/prod to options.
# =============================================================================

name: Deploy

on:
  # SUSPENDED: Automatic staging deployment on push to main
  # push:
  #   branches:
  #     - main

  # SUSPENDED: Automatic production deployment on version tags
  # push:
  #   tags:
  #     - 'v*'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          # SUSPENDED during development phase:
          # - staging
          # - prod
      image_tag:
        description: 'Docker image tag to deploy (defaults to branch/tag name)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---------------------------------------------------------------------------
  # Determine deployment parameters
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
      resource_group: ${{ steps.set-env.outputs.resource_group }}
    steps:
      - name: Determine environment and image tag
        id: set-env
        run: |
          # Determine environment
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
            TAG="${{ github.event.inputs.image_tag }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="prod"
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="staging"
            TAG="main"
          else
            ENV="dev"
            TAG="${{ github.ref_name }}"
          fi

          # Use provided tag or default
          if [[ -z "$TAG" ]]; then
            TAG="${{ github.ref_name }}"
          fi

          # Set resource group name
          RG="rg-sales-portal-${ENV}"

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "resource_group=${RG}" >> $GITHUB_OUTPUT

          echo "### Deployment Parameters" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${ENV}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group:** ${RG}" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Deploy Infrastructure and Application
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to ${{ needs.prepare.outputs.environment }}
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: ${{ needs.prepare.outputs.environment }}
      url: ${{ steps.deploy.outputs.webapp_url }}
    permissions:
      id-token: write
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        run: |
          az group create \
            --name ${{ needs.prepare.outputs.resource_group }} \
            --location westeurope \
            --tags Environment=${{ needs.prepare.outputs.environment }} Application=sales-portal ManagedBy=Bicep \
            2>/dev/null || echo "Resource group already exists"

      - name: Deploy Bicep infrastructure
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ needs.prepare.outputs.resource_group }}
          template: ./infra/main.bicep
          parameters: >-
            environment=${{ needs.prepare.outputs.environment }}
            containerImage=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}
            ghcrUsername=${{ github.actor }}
            ghcrToken=${{ secrets.GITHUB_TOKEN }}
            geinsApiEndpoint=${{ vars.GEINS_API_ENDPOINT || 'https://api.geins.io/graphql' }}
            storageDriver=${{ vars.STORAGE_DRIVER || 'fs' }}
            redisUrl=${{ secrets.REDIS_URL }}
            enableAnalytics=${{ vars.ENABLE_ANALYTICS || 'false' }}
            logLevel=${{ vars.LOG_LEVEL || 'info' }}
          failOnStdErr: false

      - name: Get deployment outputs
        id: outputs
        run: |
          WEBAPP_URL=$(az deployment group show \
            --resource-group ${{ needs.prepare.outputs.resource_group }} \
            --name main \
            --query properties.outputs.webAppUrl.value \
            --output tsv 2>/dev/null || echo "")
          
          WEBAPP_NAME=$(az deployment group show \
            --resource-group ${{ needs.prepare.outputs.resource_group }} \
            --name main \
            --query properties.outputs.webAppName.value \
            --output tsv 2>/dev/null || echo "")
          
          echo "webapp_url=${WEBAPP_URL}" >> $GITHUB_OUTPUT
          echo "webapp_name=${WEBAPP_NAME}" >> $GITHUB_OUTPUT

      - name: Wait for container to start
        run: |
          echo "Waiting for container to start (this may take up to 5 minutes for cold starts)..."
          
          # Initial wait for container pull and initialization
          sleep 60
          
          WEBAPP_URL="${{ steps.outputs.outputs.webapp_url }}"
          if [[ -n "$WEBAPP_URL" ]]; then
            echo "Checking health at ${WEBAPP_URL}/api/health"
            MAX_ATTEMPTS=20
            WAIT_SECONDS=15
            
            for i in $(seq 1 $MAX_ATTEMPTS); do
              HTTP_CODE=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" --max-time 30 "${WEBAPP_URL}/api/health" || echo "000")
              
              if [[ "$HTTP_CODE" == "200" ]]; then
                echo "✅ Health check passed!"
                cat /tmp/health_response.txt
                break
              elif [[ "$HTTP_CODE" == "000" ]]; then
                echo "⏳ Attempt $i/$MAX_ATTEMPTS: Connection failed (container may still be starting)..."
              else
                echo "⏳ Attempt $i/$MAX_ATTEMPTS: HTTP $HTTP_CODE - container starting..."
              fi
              
              if [[ $i -eq $MAX_ATTEMPTS ]]; then
                echo "⚠️ Health check did not pass after $MAX_ATTEMPTS attempts"
                echo "Check Azure portal for container logs: az webapp log tail --resource-group ${{ needs.prepare.outputs.resource_group }} --name ${{ steps.outputs.outputs.webapp_name }}"
              else
                sleep $WAIT_SECONDS
              fi
            done
          fi

      - name: Create deployment summary
        run: |
          echo "### Deployment Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.prepare.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | ${{ steps.outputs.outputs.webapp_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.outputs.outputs.webapp_url }} |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Production Slot Swap (only for production deployments)
  # ---------------------------------------------------------------------------
  swap-slots:
    name: Swap Production Slots
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: needs.prepare.outputs.environment == 'prod'
    environment:
      name: prod-swap
      url: ${{ steps.swap.outputs.production_url }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Web App name
        id: get-webapp
        run: |
          WEBAPP_NAME=$(az deployment group show \
            --resource-group ${{ needs.prepare.outputs.resource_group }} \
            --name main \
            --query properties.outputs.webAppName.value \
            --output tsv)
          echo "webapp_name=${WEBAPP_NAME}" >> $GITHUB_OUTPUT

      - name: Swap staging slot to production
        id: swap
        run: |
          echo "Swapping staging slot to production..."
          az webapp deployment slot swap \
            --resource-group ${{ needs.prepare.outputs.resource_group }} \
            --name ${{ steps.get-webapp.outputs.webapp_name }} \
            --slot staging \
            --target-slot production
          
          WEBAPP_URL="https://${{ steps.get-webapp.outputs.webapp_name }}.azurewebsites.net"
          echo "production_url=${WEBAPP_URL}" >> $GITHUB_OUTPUT
          
          echo "### Production Slot Swap Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "Production URL: ${WEBAPP_URL}" >> $GITHUB_STEP_SUMMARY
